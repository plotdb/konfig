<div><script type="@plotdb/block">var singleton;singleton={digest:{}};module.exports={pkg:{extend:{name:"@plotdb/konfig",version:"main",path:"base"},dependencies:[{name:"ldfile"}]},init:function(e){var t,n,r,u,i,l,o,s,a,f,d=this;t=e.root,n=e.context,r=e.data,u=e.pubsub;i=n.ldview,l=n.ldfile;o=r.dataSource||{};this._meta=r;s={files:[],digest:singleton.digest};a=function(e){return e.map(function(e){return{name:e.name,size:e.size,type:e.type,lastModified:e.lastModified,key:e.key,idx:e.idx,digest:e.digest}})};u.fire("init",{get:function(){return a(s.files)},set:function(e){s.files=(Array.isArray(e)?e:[e]).map(function(e,t){var n,r,i;return r=(i=import$({},e),i.idx=t,i),r.blob=(n=s.digest[e.digest]||{}).blob,r.dataurl=n.dataurl,r});return f.get("input").value=""},default:function(){return[]},meta:function(e){return d._meta=e},object:function(){var t,e;t={changed:false};e=s.files.map(function(n,r){var e;if(n.blob){return Promise.resolve(n)}if(s.digest[n.digest]){return Promise.resolve((n.blob=(e=s.digest[n.digest]).blob,n.dataurl=e.dataurl,n))}if(n.result){n.dataurl=n.result;fetch(n.result).then(function(e){return e.blob()}).then(function(e){var t;n.name=n.name||"unnamed";t=(n.blob=e,n);t.size=e.size;t.type=e.type;t.lastModified=Date.now();delete n.result;if(o.digest==null){return n}else{return o.digest(n,r).then(function(e){return n.digest=e,n})}}).then(function(t){if(o.getKey==null){return t}else{return o.getKey(t,r).then(function(e){return t.key=e,t})}}).then(function(e){if(!e.digest){return e}else{return s.digest[e.digest]=e}}).then(function(){return t.changed=true})}if(n.key==null||o.getBlob==null){return Promise.resolve(n)}return o.getBlob(n,r).then(function(e){n.blob=e;return l.fromFile(e,"dataurl").then(function(e){n.dataurl=e.result;if(o.digest==null){return}return o.digest(n,r).then(function(e){if(n.digest!==e){t.changed=true}return n.digest=e})})})});return Promise.all(e).then(function(){if(t.changed){debounce(0).then(function(){return u.fire("event","change",a(s.files))})}return s.files})}});return f=new i({root:t,init:{input:function(e){var t;t=e.node;if(d._meta.multiple){return t.setAttribute("multiple",true)}}},action:{change:{input:function(e){var r,t,i;r=e.node;t=function(){var e,t,n=[];for(e=0,t=r.files.length;e<t;++e){i=e;n.push(r.files[i])}return n}().map(function(n,r){return l.fromFile(n,"dataurl").then(function(e){var t;return t={name:n.name,size:n.size,type:n.type,lastModified:n.lastModified},t.dataurl=e.result,t.blob=n,t.idx=r,t}).then(function(t){if(o.digest==null){return t}else{return o.digest(t,r).then(function(e){return t.digest=e,t})}}).then(function(t){if(o.getKey==null){return t}else{return o.getKey(t,r).then(function(e){return t.key=e,t})}}).then(function(e){if(!e.digest){return e}else{return s.digest[e.digest]=e}})});return Promise.all(t).then(function(e){s.files=e;r.value="";return u.fire("event","change",a(e))})}}}})}};function import$(e,t){var n={}.hasOwnProperty;for(var r in t)if(n.call(t,r))e[r]=t[r];return e}</script></div>